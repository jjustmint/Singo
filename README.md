# Singo

Singo is a full-stack vocal training and performance challenge platform. The mobile app lets singers browse curated tracks, pick the key that best suits their voice, rehearse with on-device lyrics, record takes, and track progress through weekly challenges. A Bun/Hono API, Prisma/PostgreSQL datastore, and FastAPI-based audio services power automatic key detection, multi-key stem generation, and AI-assisted vocal scoring.

## Features
- **Song discovery & playback** – Browse trending releases, stream previews, cache stems, and follow time-synced lyrics from the Expo app (`frontend/app/page/Home.tsx`, `MusicPlayer.tsx`).
- **Adaptive key workflow** – Upload masters once and let the backend create instrumental/vocal stems in multiple keys using librosa + Spleeter (`backend/python/shift_splitting.py`).
- **Practice, record, and analyze** – Record compressed takes on device, upload them, and receive accuracy, quality tier, and mistake timestamps generated by the compare service (`backend/src/controllers/uploadRecord.ts`).
- **Weekly challenge & leaderboard** – Pick the featured version, submit takes, and view cached rankings plus challenge metadata (`frontend/app/page/Leaderboard.tsx`, `/private/getleaderboard`).
- **Profiles & history** – Persist preferred keys, avatars, past recordings, detected mistakes, and lyric annotations through the authenticated `/private/*` routes.
- **Modular services** – Bun API, FastAPI ML microservices, and Expo client can run independently, making it easy to scale pieces or iterate in isolation.

## Tech Stack
- **Mobile** – React Native + Expo Router, React Navigation, Expo AV/FileSystem, AsyncStorage, Reanimated, custom audio caching.
- **Backend API** – Bun 1.1+, Hono, Prisma ORM, PostgreSQL, fluent-ffmpeg for server-side conversions, JWT auth, cookie helpers.
- **Audio/ML services** – FastAPI apps (`backend/python`) leveraging librosa, Spleeter, FastDTW, noisereduce, TensorFlow, and uvicorn.
- **Storage** – Postgres for relational data, local `data/uploads` & `song/` trees for masters, stems, thumbnails, and user recordings served through `/uploads/*` static routes.

## Repository Layout
```
.
├── backend/              # Bun API, Prisma schema, FastAPI helpers
│   ├── src/
│   │   ├── controllers/  # Auth, songs, leaderboard, compare, profile, etc.
│   │   ├── models/       # Prisma data-access helpers
│   │   ├── routes/       # /auth and /private routers + middleware
│   │   └── utils/        # response helpers, JWT middleware, validators
│   ├── prisma/           # schema.prisma + generated client output
│   └── python/           # Key detection, stem splitting, vocal comparison APIs
├── frontend/             # Expo app (app router, tabs, screens, assets, APIs)
│   ├── app/              # Screens (Home, MusicPlayer, Leaderboard, etc.)
│   ├── api/              # REST helpers that talk to the Bun API
│   ├── util/             # Axios instance, audio cache, cookie helpers
│   └── assets/
└── README.md
```

## Prerequisites
- Bun **1.1+** (backend scripts use Bun-run / `bunx`).
- Node.js **18+** and npm (or pnpm/yarn) for the Expo client.
- Python **3.10+** with `pip` and a working C toolchain (needed for librosa/noisereduce/TensorFlow).
- PostgreSQL **14+** (any version supported by Prisma is fine) and access to a `DATABASE_URL`.
- `ffmpeg` installed on the machine (`backend/src/controllers/uploadRecord.ts` shells out through fluent-ffmpeg).
- Optional but recommended: Watchman (macOS) for Expo fast refresh and `ngrok`/LAN tooling if testing on physical devices.

## Backend Setup (Bun + Hono) *(optional for local work)*
> The production backend is already deployed for day-to-day usage. Only follow this section if you want to spin up your own local API or work on backend features.

1. **Install dependencies**
   ```bash
   cd backend
   bun install
   ```
2. **Configure environment**
   Create `backend/.env` (Bun automatically loads `.env` files) and supply the required variables:
   ```ini
   DATABASE_URL="postgresql://USER:PASSWORD@localhost:5432/singo"
   JWT_SECRET="replace-with-a-long-random-string"
   # optional: override where user uploads are stored
   UPLOAD_BASE_PATH="data/uploads/users"
   ```
3. **Prepare the database**
   ```bash
   bunx prisma db push        # or `bunx prisma migrate dev --name init`
   bunx prisma generate       # regenerates the client in src/generated/prisma
   ```
   Use `bunx prisma studio` if you want to inspect data.
4. **Run the API**
   ```bash
   bun run dev                # hot reloads on port 8000
   ```
   Build & run the compiled bundle with:
   ```bash
   bun run compile            # outputs dist/index.js
   bun run start
   ```

> The API serves static assets under `/uploads/*` from `backend/data` and `/song/*` from the repository root. Make sure those folders are writable (they store album art, stems, and user recordings).

## Audio ML Services (FastAPI)
All supporting services live under `backend/python`. They share the same dependency set defined in `requirement.txt`.

```bash
cd backend/python
python -m venv .venv
source .venv/bin/activate          # .\.venv\Scripts\activate on Windows
pip install -r requirement.txt
```

The `requirement.txt` file installs the exact Python libraries needed by the FastAPI microservices:

- `fastapi`, `uvicorn`, `pydantic` – web framework, ASGI server, and schema validation.
- `numpy`, `scipy`, `numba` – core scientific stack for signal processing.
- `librosa`, `soundfile` – audio loading, STFT/chromagram helpers, and file IO.
- `fastdtw` – efficient Dynamic Time Warping used in the vocal comparison service.
- `noisereduce` – reduces background noise before feature extraction.
- `spleeter` – separates vocals/instrumentals when generating stems.

Some of these packages require system-level tooling (FFmpeg, libsndfile, C/C++ build tools). Install them via your OS package manager before running `pip install`.

Run the individual apps (each can use a separate terminal/tab):

| Service | File | Port | Used by |
| --- | --- | --- | --- |
| Key detection | `KeyDetector.py` | `8083` | `shift_splitting.py` via `http://keydetector-api:8083/keydetect` to infer the tonic of uploaded masters. |
| Stem splitting & pitch shifting | `shift_splitting.py` | `8085` | `CreateSongAndVersionController` uploads masters here, receives multi-key stems + metadata. |
| Vocal comparison & scoring | `com5.py` | `8080` | `/private/comparevocal` and `/private/uploaduserrecord` send instrumental + user takes here for DTW-based scoring and mistake extraction. |

If you are not running the services via Docker with internal hostnames (`keydetector-api`, `com5-api`), update the URLs inside the Bun controllers to point to `http://localhost:{port}`.

## Frontend Setup (Expo Router)
1. **Configure the API base URL** – `frontend/constant.ts` ships with the production endpoint. Switch it to your local API when developing:
   ```ts
   export const GlobalConstant = {
     API_URL: "http://localhost:8000", // or LAN IP reachable by your device
   };
   ```
2. **Install dependencies**
   ```bash
   cd frontend
   npm install
   ```
3. **Run the app**
   ```bash
   cd frontend
   npx expo start
   ```
   You should see the familiar Expo Metro banner printed in your terminal:
   ```
   ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
   █ ▄▄▄▄▄ █▀▀ ██▀█ ▄█ ▄▄▄▄▄ █
   █ █   █ █▄▀██▀█▄▀ █ █   █ █
   █ █▄▄▄█ █ ▄ █  ▀ ██ █▄▄▄█ █
   █▄▄▄▄▄▄▄█ █ ▀▄█▄█▄█▄▄▄▄▄▄▄█
   █  █▄▀▀▄▄▀▀█  ▄▀▄▄▀  ▄▀▄▄▀█
   █ ▄█▀▀▄▄█▄▀▀  ▀ ▀▄▄▀ ▀▀█▄▄█
   █▄███▀▀▄ ▄█▄ █  █▀█ ▄█ ██▀█
   █▄▀ ▄▀▀▄█▀▀▄ █▀██ ▄▄ ▀▀██▄█
   █▄▄▄███▄█ ▄██ ▀▄  ▄▄▄ █ ▄ █
   █ ▄▄▄▄▄ █▄▄▄▄ █▄  █▄█  ▀ ▄█
   █ █   █ █▀  ▀▄▄▀▀▄ ▄▄ █▀▄██
   █ █▄▄▄█ █▀█ ██  █  █▄  ▄█▄█
   █▄▄▄▄▄▄▄█▄▄▄██▄▄█▄███▄▄█▄▄█

   › Metro waiting on exp://192.168.1.130:8081
   › Scan the QR code above with Expo Go (Android) or the Camera app (iOS)

   › Web is waiting on http://localhost:8081

   › Using Expo Go
   › Press s │ switch to development build

   › Press a │ open Android
   › Press i │ open iOS simulator
   › Press w │ open web

   › Press j │ open debugger
   › Press r │ reload app
   › Press m │ toggle menu
   › shift+m │ more tools
   › Press o │ open project code in your editor

   › Press ? │ show all commands

   Logs for your project will appear below. Press Ctrl+C to exit.
   ```

Expo stores JWTs and IDs in `AsyncStorage` (`frontend/util/cookies.ts`). Make sure you log in at least once via `/auth/login` so subsequent `/private/*` requests include the `Authorization` header added by `AxiosInstance.ts`.

### Running on Expo Go (mobile device)
1. Install the **Expo Go** app from the App Store or Google Play.
2. From the `frontend` directory run one of:
   ```bash
   npm run start -- --tunnel   # easiest way for devices on other networks
   npm run start               # works if the device is on the same LAN
   ```
3. Choose how to open the app:
   - Press `a` to launch the Android emulator.
   - Press `i` to launch the iOS simulator.
   - Press `w` to open the web build in your browser.
   - Or, open the Camera/Expo Go app on a **physical device connected to the same network** as your computer and scan the QR code shown in the terminal/Expo UI.
4. Ensure `GlobalConstant.API_URL` points to the deployed backend (default) or a LAN-accessible host so your phone can reach the API.

## Common Commands
| Where | Command | Description |
| --- | --- | --- |
| `backend` | `bun run dev` | Start Hono server with logging & CORS. |
| `backend` | `bunx prisma db pull` | Pull an existing DB schema (useful when attaching to an existing Postgres instance). |
| `backend` | `bun run compile && bun run start` | Build and serve the bundled API (for production). |
| `backend/python` | `python KeyDetector.py` | Start the key detector FastAPI service. |
| `frontend` | `npm run start` | Expo dev server with QR / web UI. |
| `frontend` | `npm run lint` | Run Expo/ESLint config to catch TypeScript issues. |

## API Surface (high-level)
- `POST /auth/register` – create user and provision upload folders.
- `POST /auth/login` – verify credentials, returns JWT (`token` cookie + response body).
- `GET /private/getuser` – profile info (requires `Authorization: Bearer {token}`).
- `GET /private/findallsong`, `POST /private/getsongs/latest`, `POST /private/getsong` – catalog, stems, and metadata.
- `POST /private/getleaderboard` – weekly challenge info + rankings.
- `POST /private/uploaduserrecord` – multipart upload (versionId, selected key, original audio path) that triggers conversion and vocal comparison.
- Additional `/private/*` helpers cover lyrics, mistakes, history, key preference, challenge selection, and profile updates.

Refer to `backend/src/routes/private.router.ts` for every protected endpoint and `frontend/api/*` for the corresponding client wrappers.

## Data & Storage Notes
- User-generated files live under `backend/data/uploads/users/{userId}` (profile photos, recordings). Album art and preview clips are stored alongside song masters.
- Generated stems are placed under `backend/song/{song_name}/{instru|vocal}` and referenced via relative paths so they can be served directly by the Bun static file middleware.
- Remove or rotate files via dedicated controllers; deleting them manually without updating the database will break playback.

## Troubleshooting
- **401 responses from `/private/*`** – ensure the Expo app is pointing at the correct API URL and that the login call succeeded so AsyncStorage contains the JWT.
- **`Error: spawn ffmpeg ENOENT`** – install `ffmpeg` and make sure it is on your PATH; `fluent-ffmpeg` depends on the binary.
- **Long song uploads** – `shift_splitting.py` can take minutes because it runs Spleeter + pitch shifting for each semitone. Keep an eye on RAM/GPU usage or reduce the `SHIFTS` range if needed.
- **Python services unreachable** – update the URLs in `backend/src/controllers/*.ts` (compare vocal, create song) to match the hostnames/ports where your FastAPI apps run.
- **Expo device cannot reach backend** – use your machine’s LAN IP in `GlobalConstant.API_URL` or expose the Bun server via `npx expo start --tunnel`.

---
Feel free to adapt the stack to your environment—every layer (Expo client, Bun API, ML services) can be started independently, which makes Singo a flexible playground for experimenting with audio processing and singer training experiences.
